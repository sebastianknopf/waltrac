<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Waltrac Realtime GNSS Tracker</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

    <style>
        html, body {
            margin: 0;
            height: 100%;
            font-family: Roboto, Arial, sans-serif;
        }

        body {
            display: flex;
            flex-direction: column;
        }

        header {
            background-color: #018685;
            color: white;
            padding: 12px 16px;
            font-size: 1.2rem;
            font-weight: 500;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            flex-shrink: 0;
        }

        /* =========================
           Map container
        ========================== */

        #map-container {
            position: relative;
            height: 65vh;
            transition: height 0.25s ease;
        }

        #map-container.fullscreen {
            position: fixed;
            inset: 0;
            z-index: 1000;
            height: 100vh;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        /* =========================
           Fullscreen Button
        ========================== */

        .fullscreen-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1001;
            background-color: #018685;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 0.85rem;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.35);
        }

        .fullscreen-btn:hover {
            background-color: #016a66;
        }

        /* =========================
           Footer (default: mobile)
        ========================== */

        footer {
            padding: 12px;
            background: #fafafa;
            box-shadow: 0 -2px 6px rgba(0,0,0,0.1);
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }

        footer input {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-size: 0.9rem;
            flex: 1;
            min-width: 120px;
        }

        button {
            background-color: #018685;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 14px;
            cursor: pointer;
            font-size: 0.9rem;
            white-space: nowrap;
        }

        button:hover {
            background-color: #016a66;
        }

        .connection-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status {
            font-size: 0.85rem;
            white-space: nowrap;
        }

        .status.connected { color: #2e7d32; }
        .status.error { color: #d32f2f; }
        .status.connecting { color: #555; }

        #error {
            width: 100%;
            font-size: 0.85rem;
            color: #d32f2f;
        }

        /* =========================
           Desktop layout
        ========================== */

        @media (min-width: 768px) {
            #map-container {
                flex: 1;
                height: auto;
            }

            footer {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                z-index: 900;
            }

            body {
                padding-bottom: 96px; /* space for footer */
            }
        }

        /* =========================
           Mobile layout tweaks
        ========================== */

        @media (max-width: 767px) {
            footer {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>

<header>Waltrac Realtime GNSS Tracker</header>

<div id="map-container">
    <button class="fullscreen-btn" id="fullscreenBtn">Fullscreen</button>
    <div id="map"></div>
</div>

<footer>
    <input id="host" placeholder="Host">
    <input id="port" placeholder="Port">
    <input id="username" placeholder="Username">
    <input id="password" type="password" placeholder="Password">

    <div class="connection-controls">
        <button id="connectBtn">Connect</button>
        <div id="status" class="status">Not connected</div>
    </div>

    <div id="error"></div>
</footer>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    const TOPIC = "waltrac/pos/#";
    let client = null;

    const map = L.map("map").setView([51, 10], 6);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

    const markers = {};

    const statusEl = document.getElementById("status");
    const errorEl = document.getElementById("error");
    const btn = document.getElementById("connectBtn");
    const mapContainer = document.getElementById("map-container");
    const fullscreenBtn = document.getElementById("fullscreenBtn");

    fullscreenBtn.addEventListener("click", () => {
        mapContainer.classList.toggle("fullscreen");
        fullscreenBtn.textContent =
            mapContainer.classList.contains("fullscreen")
                ? "Exit fullscreen"
                : "Fullscreen";
        setTimeout(() => map.invalidateSize(), 300);
    });

    function setStatus(text, cls = "") {
        statusEl.textContent = text;
        statusEl.className = "status " + cls;
    }

    function parsePosition(payload) {
        const view = new DataView(payload.buffer, payload.byteOffset, payload.byteLength);
        let offset = 0;

        if (payload.byteLength < 17) return null;

        const header = view.getUint8(offset++);
        if (!(header & 0x01)) return null;

        view.getUint8(offset++); // interval
        const confidence = view.getUint8(offset++);
        const satellites = view.getUint8(offset++);

        const devBytes = new Uint8Array(payload.buffer, payload.byteOffset + offset, 6);
        offset += 6;

        const deviceHex = Array.from(devBytes)
            .map(b => b.toString(16).padStart(2, "0"))
            .join("");

        const lat = view.getInt32(offset, false) / 1e7;
        offset += 4;
        const lon = view.getInt32(offset, false) / 1e7;
        offset += 4;

        let name = deviceHex;
        if (offset < payload.byteLength) {
            const len = view.getUint8(offset++);
            if (len && offset + len <= payload.byteLength) {
                name = new TextDecoder().decode(
                    new Uint8Array(payload.buffer, payload.byteOffset + offset, len)
                );
            }
        }

        return { name, lat, lon, satellites, confidence };
    }

    function handleMessage(topic, payload) {
        const msg = parsePosition(payload);
        if (!msg) return;

        const popupHtml = `
            <strong>${msg.name}</strong><br><br>
            Num Satellites: ${msg.satellites}<br>
            Confidence: ${msg.confidence}<br><br>
            Position: ${msg.lat.toFixed(6)}, ${msg.lon.toFixed(6)}
        `;

        if (!markers[msg.name]) {
            markers[msg.name] = L.marker([msg.lat, msg.lon]).addTo(map);
        } else {
            markers[msg.name].setLatLng([msg.lat, msg.lon]);
        }

        markers[msg.name].bindPopup(popupHtml);
    }

    function connect() {
        setStatus("Connectingâ€¦", "connecting");

        client = mqtt.connect(`wss://${host.value}:${port.value}/mqtt`, {
            username: username.value,
            password: password.value
        });

        client.on("connect", () => {
            setStatus("Connected", "connected");
            btn.textContent = "Disconnect";
            client.subscribe(TOPIC);
        });

        client.on("error", err => {
            setStatus("Error", "error");
            errorEl.textContent = err.message;
        });

        client.on("message", handleMessage);
    }

    function disconnect() {
        if (client) client.end(true);
        client = null;
        btn.textContent = "Connect";
        setStatus("Not connected");
    }

    btn.addEventListener("click", () => {
        btn.textContent === "Connect" ? connect() : disconnect();
    });
</script>

</body>
</html>